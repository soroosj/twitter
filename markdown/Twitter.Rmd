---
title: Twitter
author: Joel Soroos
date: '2020-11-22'
slug: twitter
categories: []
tags:
  - tidyverse
  - r
  - rstats
  - gt
  - rtweet
  - ggmap
---


### Motivation
The goal of this blog is to source and analyze Twitter posts and followers for a given handle using R.  We will calculate the geographic distribution of followers by accessing the [Google Maps API](https://developers.google.com/maps/documentation) via the [ggmaps package](https://cran.r-project.org/web/packages/ggmap/ggmap.pdf), then visualize tables with the [gt package](https://gt.rstudio.com/) and charts with the [ggplot package](https://ggplot2.tidyverse.org/).

### 1. Setup
First step is to load the rtweet package to obtain tweet and follower data from the Twitter API.  You will need to obtain an access token  by following steps [here](https://cran.r-project.org/web/packages/rtweet/vignettes/auth.html).
```{r , warning = TRUE, results = FALSE, message = FALSE}
   
   library (rtweet)

   twitter_user <- "soroosj"
   sample <- 15

```


### 2a. Source tweets
```{r , warning = TRUE, message = FALSE}
   
   library (tidyverse)
   library (lubridate)

   tweets_raw <- get_timeline (twitter_user, n = sample)
```


### 2b. Transform tweets
```{r , warning = TRUE, message = FALSE}

   tweets <- tweets_raw %>%
      filter (is_retweet == FALSE) %>%
      rename (
         likes = favorite_count,
         retweets = retweet_count,
         created = created_at
         ) %>%
      mutate (
         text_length = str_length(text),
         text = str_sub(text,1,60),
         created = as.Date(created),
         year = year(created)
         ) %>%
      select (text, year, likes, retweets, created)
```


### 2c. Visualize - top liked tweets
We will sort by most likes and rank via the dplyr row_to_column formula.  The GT package formats in a easy-to-read manner.
```{r chart_likes, warning = TRUE, message = FALSE}

   library (gt)

   tweets %>%
      arrange (-likes, -retweets) %>%
      head (10) %>%
      rowid_to_column("rank") %>%
      select (-year) %>%
      relocate (rank) %>%
      gt () 
```


### 2d. Top retweeted tweets
We will re-sort and re-rank by retweets, again using the GT package to cleanly format.
```{r chart_retweet, warning = TRUE, message = FALSE}

   tweets %>%
      arrange (-retweets, -likes) %>%
      head (10) %>%
      rowid_to_column("rank") %>%
      select (rank, text, retweets, likes, created) %>%
      gt ()
```


### 2e. Subtotal tweets by year
```{r chart_year, warning = F, message =F}

   tweets_agg <-
      tweets %>%
      group_by (year) %>%
      summarize (
         n = n (),
         likes = sum(likes),
         retweets = sum (retweets)
         ) %>%
      arrange (-year)

   tweets_agg
```


### 2f. Subtotaling retweets by year
```{r warning = F, message =F}

   ggplot (tweets_agg, aes (x = year, y =  likes)) +
      geom_col () +
      geom_label (aes(label = likes)) +
      theme_minimal() +
      labs (x="", y = "Likes")
```


### 2g. Subtotaling retweets by year
```{r warning = F, message =F}

   ggplot (tweets_agg, aes (x = year, y =  retweets)) +
      geom_col () +
      geom_label (aes(label = retweets)) +
      theme_minimal() +
      labs (x="", y = "Retweets")
```


### 3a. Source followers
```{r warning = F, message =F}

  followers <- twitter_user %>%
      get_followers() %>%
      pull (user_id) %>%
      lookup_users () %>%
      select (screen_name, name, location, followers_count) %>%
      arrange (-followers_count) %>%
      rowid_to_column("rank")
```


### 3b. Top followers
```{r warning = F, message =F}

   followers %>%
      head (10) %>%
      select (rank, name, location, followers_count) %>%
      gt () %>%
         fmt_number (columns = vars(followers_count), use_seps = T, decimals = 0)
```


### 3c. Obtain geographic attributes
Twitter provides a location for each user which can be converted using the Google Maps API to geographic coordinates for mapping.  
```{r warning = F, message =F}
   
   library (ggmap)

   register_google(key = Sys.getenv("GOOGLE_MAPS_API"))

   followers_geo <- followers %>%
      head (sample) %>%
      mutate_geocode (location, output = "more") %>%
      mutate (
         country = word (address, -1,-1),
         country = str_to_upper(country),
         country = ifelse(is.na(country), "NOT LISTED", country)
         ) %>%
      select (rank:followers_count, country, lon, lat) 
   
   followers_geo
```


### 3d. Followers by country
```{r warning = F, message =F}

   followers_agg <- followers_geo %>%
      count (country) %>%
      arrange (-n)
   
   ggplot (followers_agg, aes (x = reorder(country, n), y = n)) +
      geom_col () +
      geom_label (aes(label = n)) +
      coord_flip () +
      theme_minimal() +
      labs (x="", y = "Followers")
```


### 3e. Followers map
```{r warning = F, message =F}
   
   library (maps)

   world <- map_data ("world")

   ggplot () +
      geom_map (data = world, map = world, aes (long, lat, map_id = region), fill = "lightgray", color = "black", size =0.05) +
      geom_point (data = followers_geo, aes (x = lon, y = lat), color = "blue", size = 0.75) + 
      theme_grey ()
```