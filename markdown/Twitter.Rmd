---
title: Twitter
author: Joel Soroos
date: '2020-11-22'
slug: twitter
categories: []
tags:
  - tidyverse
  - r
  - rstats
  - gt
  - rtweet
  - ggmap
---


## Purpose
The goal of this post is to source and analyze Twitter posts and followers for a given Twitter account ("handle") using R.  We will identify tweets with the most likes and retweets, as well as analyze posting trends over time.  We will also calculate the geographic distribution of Twitter followers via the Google Maps API.  

## 1. Setup

First, we need to obtain and authorize a free Twitter Developer account (instructions [here](https://cran.r-project.org/web/packages/rtweet/vignettes/auth.html)).

Second step is to install and load the R [rtweet](https://cran.r-project.org/web/packages/rtweet/rtweet.pdf) package by Michael Kearney. 

We will extract Twitter data multiple times so I have created two variables to avoid duplication and inconsistencies.  The "twitter_user" variable stores the Twitter handle.  The "sample" variable specifies the number of extracted records as some Twitter accounts have large volumes of followers and tweets.

```{r , warning = TRUE, results = FALSE, message = FALSE}
   
   library (rtweet)

   twitter_user <- "soroosj"
   sample <- 105
```


## 2. Tweets
#### Source tweets
Now we will extract our first set of Twitter data, which will be tweets from our specified account.  The get_timeline function contains 90 fields on each tweet.  

```{r , warning = FALSE, message = FALSE}

   tweets_raw <- get_timeline (twitter_user, n = sample)
```


#### Transform Tweets
Many fields are not needed for this exercise so we can cull the dataset.  I have also renamed several fields for brevity and to more standard Twitter notation (i.e. likes instead of favorites).

We are focusing on original tweets so have filtered out retweets.

I have extracted year from the creation date to enable summarizing tweet volume by year.  Also, I have truncated the Tweet text field from 280 to 60 characters so more cleanly fits in a formatted table. 

```{r , warning = TRUE, message = FALSE}

   library (tidyverse)
   library (lubridate)

   tweets <- tweets_raw %>%
      filter (is_retweet == FALSE) %>%
      rename (
         likes = favorite_count,
         retweets = retweet_count,
         created = created_at
         ) %>%
      mutate (
         text = str_sub(text,1,60),
         created = as.Date(created),
         year = year(created)
         ) %>%
      select (text, year, likes, retweets, created)
```


#### Most liked tweets of all time  
We will sort by most liked tweets over time and rank via the dplyr row_to_column formula.

The [gt package](https://gt.rstudio.com/) by Richard Iannone formats tables in a easy-to-read manner.  The core gt::gt function adds lines between rows.  Many other table formatting enhancements are available but out of scope for this blog.
```{r chart_likes, warning = TRUE, message = FALSE}

   library (gt)

   tweets %>%
      arrange (-likes, -retweets) %>%
      head (10) %>%
      rowid_to_column("rank") %>%
      select (-year) %>%
      relocate (rank) %>%
      gt () 
```

#### Most retweeted tweets of all time  
Next we will re-sort and re-rank by retweets, again using the GT package to cleanly format.
```{r chart_retweet, warning = TRUE, message = FALSE}

   tweets %>%
      arrange (-retweets, -likes) %>%
      head (10) %>%
      rowid_to_column("rank") %>%
      select (rank, text, retweets, likes, created) %>%
      gt ()
```


#### Tweet trends
Another area of interest is how tweet activity has evolved over time.  Using dplyr we can easily summarize by number of tweets by year.
```{r warning = F, message =F}

   ggplot (tweets_agg, aes (x = year, y = n)) +
      geom_col () +
      geom_label (aes(label = n)) +
      theme_minimal() +
      labs (x="", y = "Number of tweets")
```


### 3a. Source followers
```{r warning = F, message =F}

   library(skimr)

  followers <- twitter_user %>%
      get_followers() %>%
      pull (user_id) %>%
      lookup_users () %>%
      select (screen_name, name, location, followers_count) %>%
      arrange (-followers_count) %>%
      rowid_to_column("rank")

   skim (followers)
```


### 3b. Top followers
[gt package](https://gt.rstudio.com/) and charts with ggplot.
```{r warning = F, message =F}

   followers %>%
      head (10) %>%
      select (rank, name, location, followers_count) %>%
      gt () %>%
         fmt_number (columns = vars(followers_count), use_seps = T, decimals = 0)
```


### 3c. Obtain geographic attributes
Twitter provides a location for each user which can be converted using the [Google Maps API](https://developers.google.com/maps/documentation)  to geographic coordinates for mapping.  

[ggmaps package](https://cran.r-project.org/web/packages/ggmap/ggmap.pdf), 
```{r warning = F, message =F}
   
   library (ggmap)

   register_google(key = Sys.getenv("GOOGLE_MAPS_API"))

   followers_geo <- followers %>%
      head (sample) %>%
      mutate_geocode (location, output = "more") %>%
      mutate (
         country = word (address, -1,-1),
         country = str_to_upper(country),
         country = ifelse(is.na(country), "NOT LISTED", country)
         ) %>%
      select (rank:followers_count, country, lon, lat) 
   
   followers_geo
```


### 3d. Followers by country
```{r warning = F, message =F}

   followers_agg <- followers_geo %>%
      count (country) %>%
      arrange (-n)
   
   ggplot (followers_agg, aes (x = reorder(country, n), y = n)) +
      geom_col () +
      geom_label (aes(label = n)) +
      coord_flip () +
      theme_minimal() +
      labs (x="", y = "Followers")
```


### 3e. Followers map
```{r warning = F, message =F}
   
   library (maps)

   world <- map_data ("world")

   ggplot () +
      geom_map (data = world, map = world, aes (long, lat, map_id = region), fill = "lightgray", color = "black", size =0.05) +
      geom_point (data = followers_geo, aes (x = lon, y = lat), color = "blue", size = 0.75) + 
      theme_grey ()
```